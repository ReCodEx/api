#
# WARNING: it is CRITICAL that this file & directory are NOT accessible directly via a web browser!
# https://nette.org/security-warning
#
parameters:
  uploadDir: %appDir%/../uploaded_data

  jobConfig:
    storageDir: %appDir%/../job_config
    humanReadable: true

  api:
    address: https://recodex.projekty.ms.mff.cuni.cz:4000
    name: "ReCodEx API"
    description: "ReCodEx Code Examiner - API Server"
    version: "1.0.0"

  accessManager:
    leeway: 60
    issuer: https://recodex.projekty.ms.mff.cuni.cz
    audience: https://recodex.projekty.ms.mff.cuni.cz
    expiration: 86400
    usedAlgorithm: HS256
    allowedAlgorithms:
      - HS256
    verificationKey: "recodex-123"

  fileServer:
    address: http://195.113.17.8:10009
    auth:
      username: "re"
      password: "codex"
    timeouts:
      connection: 500

  broker:
    address: tcp://195.113.17.8:9668
    auth:
      username: "re"
      password: "codex"
    timeouts:
      ack: 100
      send: 5000
      result: 1000

  monitor:
    address: wss://recodex.projekty.ms.mff.cuni.cz:4443/ws

  uploads:
      removalThreshold: "1 day"

  CAS:
    serviceId: "cas-uk"
    options:
      ldap:
        hostname: "ldap.cuni.cz"
        base_dn: "ou=people,dc=cuni,dc=cz"
        #port: 389
        #security: SSL
        bindName: "cunipersonalid"
      oauth:
        baseUri: "https://idp.cuni.cz/cas/"
    fields:
      oauth:
        ukco: "cunipersonalid"
        email: "mail"
        firstName: "givenname"
        lastName: "sn"
        affiliation: "edupersonscopedaffiliation"
      ldap:
        email: "mail"
        firstName: "givenName"
        lastName: "sn"

  emails:
    apiUrl: https://recodex.projekty.ms.mff.cuni.cz:4000
    footerUrl: https://recodex.projekty.ms.mff.cuni.cz
    siteName: "ReCodEx"
    githubUrl: https://github.com/ReCodEx
    from: "ReCodEx <noreply@recodex.org>"

  failures:
    emails:
      to: "Šimon Rozsíval <simon@rozsival.com>"
      from: %emails.from%
      subjectPrefix: "ReCodEx Failure Report - "

  forgottenPassword:
    redirectUrl: "https://recodex.projekty.ms.mff.cuni.cz/en/forgotten-password/change"
    tokenExpiration: 600 # 10 minues
    emails:
      from: %emails.from%
      subjectPrefix: "ReCodEx Forgotten Password Request - "

  emailVerification:
    redirectUrl: "https://recodex.projekty.ms.mff.cuni.cz/en/email-verification"
    tokenExpiration: 600 # 10 minues
    emails:
      from: %emails.from%
      subjectPrefix: "ReCodEx Email Verification Request - "

  mail:
    smtp: true
    host: "smtp.ps.stdin.cz"
    port: 587
    username: ""
    password: ""
    secure: "tls"
    context:
      ssl:
        verify_peer: false
        verify_peer_name: false
        allow_self_signed: true


application:
  errorPresenter: V1:ApiError
  mapping:
    *: App\*Module\Presenters\*Presenter


session:
  autoStart: false
  useCookies: 0

extensions:
  console: Kdyby\Console\DI\ConsoleExtension
  events: Kdyby\Events\DI\EventsExtension
  annotations: Kdyby\Annotations\DI\AnnotationsExtension
  gedmo: Rixxi\Gedmo\DI\OrmExtension
  doctrine: Kdyby\Doctrine\DI\OrmExtension
  fixtures: Zenify\DoctrineFixtures\DI\FixturesExtension

services:
  router: App\RouterFactory::createRouter
  - Nette\Mail\SmtpMailer(%mail%)
  - class: App\Console\DoctrineFixtures
    tags: [kdyby.console.command]
  - class: App\Console\GenerateSwagger(@router)
    tags: [kdyby.console.command]
  - class: App\Console\CleanupUploads()
    tags: [kdyby.console.command]

  # security
  - App\Security\AccessManager(%accessManager%)
  - App\Security\Authorizator(%appDir%/config/permissions.neon)
  security.userStorage: App\Security\UserStorage
  - App\Security\CredentialsAuthenticator
  - class: App\Security\PolicyRegistry

  # external login services
  - App\Helpers\ExternalLogin\CAS\LDAPLoginService(%CAS.serviceId%, %CAS.options.ldap%, %CAS.fields.ldap%)
  - App\Helpers\ExternalLogin\CAS\OAuthLoginService(%CAS.serviceId%, %CAS.options.oauth%, %CAS.fields.oauth%)
  - App\Helpers\ExternalLogin\ExternalServiceAuthenticator(
    @App\Model\Repository\ExternalLogins,
    @App\Model\Repository\Users,
    @App\Helpers\ExternalLogin\CAS\LDAPLoginService,
    @App\Helpers\ExternalLogin\CAS\OAuthLoginService,
  )

  # config objects
  - App\Helpers\MonitorConfig(%monitor%)
  - App\Helpers\BrokerConfig(%broker%)
  - App\Helpers\EmailsConfig(%emails%)
  - App\Helpers\ApiConfig(%api%)
  - App\Helpers\UploadsConfig(%uploads%)

  # helpers
  - App\Helpers\EmailHelper(@Nette\Mail\SmtpMailer, %emails%)
  - App\Helpers\FailureHelper(@Kdyby\Doctrine\EntityManager, @App\Helpers\EmailHelper, %failures%)
  - App\Helpers\BrokerProxy(%broker%)
  - App\Helpers\FileServerProxy(%fileServer%)
  - App\Helpers\SubmissionHelper
  - App\Helpers\UploadedFileStorage(%uploadDir%)
  - App\Helpers\EvaluationLoader
  - App\Helpers\ForgottenPasswordHelper(@Kdyby\Doctrine\EntityManager, @App\Helpers\EmailHelper, @App\Security\AccessManager, %forgottenPassword%)
  - App\Helpers\UploadedJobConfigStorage(%jobConfig.storageDir%)
  - App\Helpers\JobConfig\Storage(%jobConfig.humanReadable%)
  - App\Helpers\JobConfig\Loader
  - App\Helpers\SimpleScoreCalculator
  - App\Helpers\ScoreCalculatorAccessor({
    simple: @App\Helpers\SimpleScoreCalculator
  })
  - App\Helpers\ExerciseFileStorage
  - App\Helpers\Notifications\AssignmentEmailsSender
  - App\Helpers\Notifications\SubmissionEmailsSender
  - App\Helpers\EmailVerificationHelper(@App\Helpers\EmailHelper, @App\Security\AccessManager, %emailVerification%)
  - App\Helpers\ExerciseConfig\Loader
  - App\Helpers\ExerciseConfig\Transformer

  # models - repositories
  - App\Model\Repository\Comments
  - App\Model\Repository\Exercises
  - App\Model\Repository\Assignments
  - App\Model\Repository\ExternalLogins
  - App\Model\Repository\Groups
  - App\Model\Repository\Instances
  - App\Model\Repository\Licences
  - App\Model\Repository\Logins
  - App\Model\Repository\Permissions
  - App\Model\Repository\ReferenceExerciseSolutions
  - App\Model\Repository\ReferenceSolutionEvaluations
  - App\Model\Repository\Resources
  - App\Model\Repository\Roles
  - App\Model\Repository\Submissions
  - App\Model\Repository\SubmissionFailures
  - App\Model\Repository\SolutionEvaluations
  - App\Model\Repository\UploadedFiles
  - App\Model\Repository\Users
  - App\Model\Repository\RuntimeEnvironments
  - App\Model\Repository\RuntimeConfigs
  - App\Model\Repository\Solutions
  - App\Model\Repository\UserActions
  - App\Model\Repository\GroupMemberships
  - App\Model\Repository\HardwareGroups
  - App\Model\Repository\ExerciseFiles
  - App\Model\Repository\AdditionalExerciseFiles

doctrine:
  user: 'root'
  password: ''
  host: localhost
  dbname: 'recodex-api'
  metadata:
    App\Model\Entity: %appDir%/model/entity
  types:
    bit: Doctrine\DBAL\Types\BooleanType

gedmo:
  softDeleteable: on

fixtures:
  locale: "en_US"
  seed: 1

annotations:
  ignore:
    - LoggedIn
    - Role
    - Resource
    - UserIsAllowed
    - POST
    - GET
    - PUT
    - DELETE
